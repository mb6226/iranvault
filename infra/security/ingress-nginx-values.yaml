controller:
  config:
    # Enable ModSecurity WAF
    enable-modsecurity: "true"
    enable-owasp-modsecurity-crs: "true"

    # ModSecurity configuration
    modsecurity-snippet: |
      # Enable ModSecurity engine
      SecRuleEngine On

      # Enable request body access for inspection
      SecRequestBodyAccess On

      # Set request body limit
      SecRequestBodyLimit 13107200
      SecRequestBodyNoFilesLimit 131072

      # Enable response body access
      SecResponseBodyAccess On
      SecResponseBodyMimeType text/plain text/html text/xml

      # Debug log level (set to 0 in production)
      SecDebugLogLevel 0

      # Default action for rules
      SecDefaultAction "phase:1,deny,log"

      # Custom rules for IranVault
      SecRule REQUEST_URI "@contains /api/v1/orders" "id:1001,phase:1,t:lowercase,deny,msg:'High frequency order endpoint protection'"

    # Global rate limiting
    global-rate-limit: "100"
    global-rate-limit-window: "1m"
    global-rate-limit-burst: "200"

    # Connection limits
    max-worker-connections: "1024"

    # Security headers
    proxy-hide-headers: "server"
    proxy-set-headers: |
      X-Frame-Options: "DENY"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"

    # SSL/TLS configuration
    ssl-protocols: "TLSv1.2 TLSv1.3"
    ssl-ciphers: "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384"
    ssl-prefer-server-ciphers: "true"

    # HSTS
    hsts: "true"
    hsts-max-age: "31536000"
    hsts-include-subdomains: "true"
    hsts-preload: "false"

    # Real IP configuration
    use-forwarded-headers: "true"
    compute-full-forwarding-headers: "true"
    forwarded-for-header: "X-Forwarded-For"

  # Resource limits
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    fsGroup: 101

  # Container security context
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 101
    capabilities:
      drop:
        - ALL

  # Service configuration
  service:
    type: LoadBalancer
    annotations:
      # Hetzner Cloud Load Balancer annotations
      load-balancer.hetzner.cloud/name: "iranvault-ingress"
      load-balancer.hetzner.cloud/use-private-ip: "false"
      load-balancer.hetzner.cloud/disable-private-ingress: "true"
      load-balancer.hetzner.cloud/hostname: "api.iranvault.com"
      # DDoS protection
      load-balancer.hetzner.cloud/algorithm: "round_robin"
      load-balancer.hetzner.cloud/health-check-interval: "10s"
      load-balancer.hetzner.cloud/health-check-timeout: "5s"

  # Node selector for security
  nodeSelector:
    kubernetes.io/os: linux
    node-type: "ingress"

  # Tolerations
  tolerations:
    - key: "node-type"
      operator: "Equal"
      value: "ingress"
      effect: "NoSchedule"

  # Affinity
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
          topologyKey: kubernetes.io/hostname

# Default backend for 404s
defaultBackend:
  enabled: true
  image:
    repository: defaultbackend-amd64
    tag: "1.5"

# RBAC
rbac:
  create: true

# Service account
serviceAccount:
  create: true
  annotations: {}

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring
    additionalLabels:
      release: prometheus